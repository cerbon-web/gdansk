<div class="modal-overlay" (click)="onCancel()">
  <div class="modal" (click)="$event.stopPropagation()" role="dialog" aria-modal="true" aria-label="{{ 'LOGIN.TITLE' | translate }}">
    <header class="modal-header">
      <nav class="tabs">
        <button [class.active]="activeTab==='login'" (click)="activeTab='login'">{{ 'LOGIN.TITLE' | translate }}</button>
        <button [class.active]="activeTab==='signup'" (click)="activeTab='signup'">{{ 'SIGNUP.TITLE' | translate }}</button>
      </nav>
      <button class="close-btn" (click)="onCancel()" aria-label="{{ 'CLOSE' | translate }}">Ã—</button>
    </header>
    <section class="modal-body">
      <div *ngIf="activeTab === 'login'">
        <label>
          {{ 'LOGIN.USERNAME' | translate }}
          <input type="text" [(ngModel)]="username" [disabled]="loading" />
        </label>
        <label>
          {{ 'LOGIN.PASSWORD' | translate }}
          <input type="password" [(ngModel)]="password" [disabled]="loading" />
        </label>
        <div *ngIf="(serverError$ | async) as srv" class="error">{{ srv }}</div>
        <div *ngIf="(messageKey$ | async) as mk">
          <div *ngIf="!((serverError$ | async) !== null)" class="error">{{ mk | translate }}</div>
        </div>
      </div>

      <div *ngIf="activeTab === 'signup'" [formGroup]="signupForm">
        <label>
          {{ 'SIGNUP.USERNAME' | translate }}
          <input type="text" formControlName="username" [disabled]="(signupLoading$ | async)" (blur)="signupForm.get('username')?.markAsTouched()" />
        </label>
        <div *ngIf="(signupForm.get('username')?.touched || submitted) && signupForm.get('username')?.errors" class="error">
          <span *ngIf="signupForm.get('username')?.errors?.required">Username is required</span>
          <span *ngIf="signupForm.get('username')?.errors?.minlength">Username must be at least 3 characters</span>
        </div>

        <label>
          {{ 'SIGNUP.PASSWORD' | translate }}
          <input type="password" formControlName="password" [disabled]="(signupLoading$ | async)" (blur)="signupForm.get('password')?.markAsTouched()" />
        </label>
        <div *ngIf="(signupForm.get('password')?.touched || submitted) && signupForm.get('password')?.errors" class="error">
          <span *ngIf="signupForm.get('password')?.errors?.required">Password is required</span>
          <span *ngIf="signupForm.get('password')?.errors?.minlength || signupForm.get('password')?.errors?.maxlength">Password must be between 3 and 15 characters</span>
        </div>

        <label>
          {{ 'SIGNUP.PASSWORD_CONFIRM' | translate }}
          <input type="password" formControlName="password2" [disabled]="(signupLoading$ | async)" (blur)="signupForm.get('password2')?.markAsTouched()" />
        </label>
        <div *ngIf="(signupForm.get('password2')?.touched || submitted) && (signupForm.get('password2')?.errors || signupForm.errors?.passwordsMismatch)" class="error">
          <span *ngIf="signupForm.get('password2')?.errors?.required">Please confirm your password</span>
          <span *ngIf="signupForm.errors?.passwordsMismatch">Passwords do not match</span>
        </div>

        <label>
          {{ 'SIGNUP.NAME' | translate }}
          <input type="text" formControlName="name" [disabled]="(signupLoading$ | async)" />
        </label>

        <label>
          {{ 'SIGNUP.PHONE' | translate }}
          <input type="tel" formControlName="phone" [disabled]="(signupLoading$ | async)" (blur)="signupForm.get('phone')?.markAsTouched()" />
        </label>
        <div *ngIf="(signupForm.get('phone')?.touched || submitted) && signupForm.get('phone')?.errors" class="error">Phone number is invalid</div>

        <div *ngIf="(signupError$ | async) as se" class="error">{{ se }}</div>
      </div>
    </section>
    <footer class="modal-footer">
      <button *ngIf="activeTab === 'login'" type="button" (click)="onLogin()" [disabled]="loading">
        <span *ngIf="!loading">{{ 'LOGIN.BUTTON' | translate }}</span>
        <span *ngIf="loading" class="loading-inline">{{ 'LOADING' | translate }}</span>
      </button>
      <button *ngIf="activeTab === 'signup'" type="button" (click)="submitSignup()" [disabled]="(signupLoading$ | async)">
        <span *ngIf="!(signupLoading$ | async)">{{ 'SIGNUP.BUTTON' | translate }}</span>
        <span *ngIf="(signupLoading$ | async)" class="loading-inline">{{ 'LOADING' | translate }}</span>
      </button>
      <button type="button" (click)="onCancel()" [disabled]="loading || (signupLoading$ | async)">{{ 'CANCEL' | translate }}</button>
    </footer>
  </div>
</div>
